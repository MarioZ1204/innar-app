// public/app.js
const $ = id => document.getElementById(id);
const lsKey = 'recibos_sencillo_v1';
const lsKeyServicios = 'servicios_list_v1';
let lastReciboId = null;

// Escapar HTML para evitar XSS al insertar en innerHTML
function escapeHtml(str) {
  if (str == null) return '';
  const s = String(str);
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

// Servicios por defecto
const serviciosDefault = [
  { nombre: 'Electroencefalograma Computarizado' },
  { nombre: 'Electroencefalograma Convencional'},
  { nombre: 'Monitorización Electroencefalográfica por video y radio'},
  { nombre: 'Polisomnografía'},
  { nombre: 'Polisomnograma en Titulación de CPAP/BPAP' },
  { nombre: 'Test de Latencia Múltiple'},
  { nombre: 'Polisomnograma Noche Dividida' }
];

function getServicios() {
  const stored = localStorage.getItem(lsKeyServicios);
  return stored ? JSON.parse(stored) : serviciosDefault;
}

function saveServicios(servicios) {
  localStorage.setItem(lsKeyServicios, JSON.stringify(servicios));
  updateServiciosSelects();
}

function editServicio(idx) {
  const servicios = getServicios();
  const nuevoNombre = prompt('Editar servicio:', servicios[idx].nombre);
  if(nuevoNombre && nuevoNombre.trim()) {
    servicios[idx].nombre = nuevoNombre.trim();
    saveServicios(servicios);
    renderServiciosList();
    showToast('Servicio actualizado', 'success');
  }
}

function renderServiciosList() {
  const servicios = getServicios();
  const list = $('serviciosList');
  list.innerHTML = '';
  servicios.forEach((s, idx) => {
    const div = document.createElement('div');
    div.className = 'servicio-item';
    const span = document.createElement('span');
    span.textContent = s.nombre;
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = 'Editar';
    btn.addEventListener('click', () => editServicio(idx));
    div.appendChild(span);
    div.appendChild(btn);
    list.appendChild(div);
  });
}

function updateServiciosSelects() {
  const servicios = getServicios();
  document.querySelectorAll('.item-desc:not(.item-desc-input)').forEach(select => {
    const currentVal = select.value;
    select.innerHTML = `<option value="">Seleccionar servicio</option>`;
    servicios.forEach(s => {
      const option = document.createElement('option');
      option.value = s.nombre;
      option.textContent = s.nombre;
      if(currentVal === s.nombre) option.selected = true;
      select.appendChild(option);
    });
    const option = document.createElement('option');
    option.value = 'custom';
    option.textContent = 'Personalizado...';
    select.appendChild(option);
  });
}

// Mostrar/ocultar loader
function showLoader(show = true) {
  let loader = document.getElementById('loader');
  if (!loader) {
    loader = document.createElement('div');
    loader.id = 'loader';
    loader.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999';
    loader.innerHTML = '<div style="background:white;padding:20px;border-radius:8px;text-align:center"><div style="font-size:24px;margin-bottom:10px">⏳</div><div>Procesando...</div></div>';
    document.body.appendChild(loader);
  }
  loader.style.display = show ? 'flex' : 'none';
}

// Mostrar toast
function showToast(msg, type = 'info') {
  const toast = document.createElement('div');
  toast.style.cssText = `position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:6px;background:${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#3b82f6'};color:white;z-index:9998;max-width:400px;box-shadow:0 4px 12px rgba(0,0,0,0.15)`;
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// init
document.addEventListener('DOMContentLoaded', ()=>{
  // Navegación de páginas
  document.querySelectorAll('.sidebar-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const page = this.dataset.page;
      // Remover clase active de todos los botones
      document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
      // Agregar clase active al botón actual
      this.classList.add('active');
      // Ocultar todas las páginas
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      // Mostrar la página actual
      document.getElementById(`page-${page}`).classList.add('active');
      
      // Si es la página de recibos, cargar la lista
      if(page === 'recibos') {
        cargarLista();
        $('resetAll').style.display = 'inline-block';
      }
      // Si es la página de servicios, mostrar la lista
      if(page === 'servicios') {
        renderServiciosList();
      }
    });
  });

  initItemsTable();
  setDefaultDate();
  nextNumber();
  updateSavedCount();
  setDefaultReportDates();
  document.getElementById('addItem').addEventListener('click', ()=> addRow());
  document.getElementById('generate').addEventListener('click', generatePreview);
  document.getElementById('resetAll').addEventListener('click', resetAllRecibos);
  document.getElementById('print').addEventListener('click', abrirPDF);
  document.getElementById('downloadPDF').addEventListener('click', descargarPDFAnterior);
  document.getElementById('reportDiaBtn').addEventListener('click', generarReporteDiario);
  document.getElementById('reportMesBtn').addEventListener('click', generarReporteMensual);
  document.getElementById('addServicio').addEventListener('click', () => {
    const nombre = $('newServicioNombre').value.trim();
    if(!nombre) {
      showToast('Ingresa el nombre del servicio', 'error');
      return;
    }
    const servicios = getServicios();
    // Verificar si ya existe
    if(servicios.some(s => s.nombre.toLowerCase() === nombre.toLowerCase())) {
      showToast('Este servicio ya existe', 'error');
      return;
    }
    servicios.push({ nombre, precio: 0 });
    saveServicios(servicios);
    $('newServicioNombre').value = '';
    renderServiciosList();
    showToast('Servicio agregado', 'success');
  });
  
  // Validar solo números en documento
  document.getElementById('docCliente').addEventListener('input', function(e) {
    this.value = this.value.replace(/[^0-9]/g, '');
  });
  
  // Manejar campo "Otra" en entidad
  document.getElementById('entidad').addEventListener('change', function() {
    const otherContainer = document.getElementById('entidadOtraContainer');
    const otherInput = document.getElementById('entidadOtra');
    if(this.value === 'Otra') {
      otherContainer.style.display = 'block';
      otherInput.focus();
    } else {
      otherContainer.style.display = 'none';
      otherInput.value = '';
    }
  });
});

function formatMoney(n){ 
  const formatted = Number(n||0).toFixed(2);
  return '$ ' + formatted.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function addRow(desc='', price=0){
  const tbody = document.querySelector('#itemsTable tbody');
  const tr = document.createElement('tr');
  
  const servicios = getServicios();
  
  const descSelect = `<select class="item-desc">
    <option value="">Seleccionar servicio</option>
    ${servicios.map(s => `<option value="${escapeHtml(s.nombre).replace(/"/g, '&quot;')}" ${desc === s.nombre ? 'selected' : ''}>${escapeHtml(s.nombre)}</option>`).join('')}
    <option value="custom">Personalizado...</option>
  </select>`;
  
  tr.innerHTML = `
    <td>${descSelect}</td>
    <td><input class="item-price" type="number" min="0" step="0.01" placeholder="0" value="${price === 0 ? '' : price}"/></td>
    <td><button class="remove" type="button">✕</button></td>
  `;
  tbody.appendChild(tr);
  
  // Event listener para el select de descripción
  const descSelect_el = tr.querySelector('.item-desc');
  descSelect_el.addEventListener('change', function(){
    const valor = this.value;
    if(valor === 'custom') {
      // Reemplazar select con input de texto personalizado
      const customDescInput = `<input class="item-desc-custom" type="text" placeholder="Descripción personalizada" style="width:100%;padding:4px;border:1px solid #ccc;box-sizing:border-box" />`;
      tr.querySelector('td:first-child').innerHTML = customDescInput;
      tr.querySelector('.item-desc-custom').focus();
      // Dejar que el usuario ingrese la descripción, el precio lo puede editar directamente en la columna de precio
    } else if(valor) {
      // Ya NO asignamos el precio automáticamente
      // El usuario debe ingresar el precio manualmente
    }
  });
  
  tr.querySelector('.remove').addEventListener('click', ()=>{ tr.remove(); recalc(); });
  tr.querySelectorAll('.item-price').forEach(inp=>inp.addEventListener('input', ()=>{ recalc(); }));
}

function initItemsTable(){
  const tbody = document.querySelector('#itemsTable tbody');
  // si no hay filas, agrega una de ejemplo
  if(!tbody.children.length) addRow();
}

function recalc(){
  const rows = document.querySelectorAll('#itemsTable tbody tr');
  let subtotal = 0;
  rows.forEach(r=>{
    const price = Number(r.querySelector('.item-price').value || 0);
    subtotal += price;
  });
  // por simplicidad IVA fijo 0% (ajusta si necesitas)
  const iva = 0;
  $('r_subtotal').textContent = formatMoney(subtotal);
  $('r_iva').textContent = formatMoney(iva);
  $('r_total').textContent = formatMoney(subtotal + iva);
}

function setDefaultDate(){
  const f = new Date().toISOString().slice(0,10);
  $('fecha').value = f;
  $('fecha').readOnly = true;
  $('fecha').style.cursor = 'not-allowed';
  $('fecha').style.backgroundColor = '#f0f0f0';
}

async function nextNumber(){
  // pedimos al servidor la lista y calculamos siguiente
  try {
    const res = await fetch('/api/recibos');
    const arr = await res.json();
    // Buscar el máximo número entre todos los recibos
    // SOLO contar números pequeños (secuenciales, no timestamps)
    let maxNum = 0;
    arr.forEach(r => {
      const num = Number(r.numero);
      // Solo contar números menores a 10000 (ignorar timestamps)
      if(!isNaN(num) && num > maxNum && num < 10000) maxNum = num;
    });
    const next = maxNum + 1;
    $('numero').value = String(next).padStart(4,'0');
  } catch(e) {
    // si falla el servidor, fallback local
    const saved = JSON.parse(localStorage.getItem(lsKey) || '[]');
    let maxNum = 0;
    saved.forEach(r => {
      const num = Number(r.numero);
      if(!isNaN(num) && num > maxNum && num < 10000) maxNum = num;
    });
    $('numero').value = String(maxNum + 1).padStart(4,'0');
  }
  updateSavedCount();
}

function collectFormData(){
  const items = [];
  document.querySelectorAll('#itemsTable tbody tr').forEach(r=>{
    // Si hay input personalizado, usar su valor; si no, usar el select
    const descEl = r.querySelector('.item-desc-custom') || r.querySelector('.item-desc');
    items.push({
      desc: descEl.value,
      price: Number(r.querySelector('.item-price').value || 0)
    });
  });
  // Extraer solo los números del textContent (remover $ y comas)
  const subtotal = Number($('r_subtotal').textContent.replace(/[^\d.]/g, '') || 0);
  const iva = Number($('r_iva').textContent.replace(/[^\d.]/g, '') || 0);
  const total = Number($('r_total').textContent.replace(/[^\d.]/g, '') || 0);
  return {
    numero: $('numero').value,
    fecha: $('fecha').value,
    cliente: $('cliente').value,
    doc: $('docCliente').value,
    entidad: $('entidad').value === 'Otra' ? $('entidadOtra').value : $('entidad').value,
    observ: $('observ').value,
    items, subtotal, iva, total
  };
}

function generatePreview(){
  if(!validarFormulario()) return;
  
  // llenar campos del preview
  $('r_num').textContent = $('numero').value;
  $('r_fecha').textContent = $('fecha').value;
  $('r_cliente').textContent = $('cliente').value;
  $('r_doc').textContent = $('docCliente').value;
  $('r_observ').textContent = $('observ').value;

  const tbody = document.querySelector('#r_table tbody'); tbody.innerHTML = '';
  document.querySelectorAll('#itemsTable tbody tr').forEach(r=>{
    // Si hay input personalizado, usar su valor; si no, usar el select
    const descEl = r.querySelector('.item-desc-custom') || r.querySelector('.item-desc');
    const desc = descEl.value;
    const price = Number(r.querySelector('.item-price').value || 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(desc)}</td><td style="text-align:right">${escapeHtml(formatMoney(price))}</td>`;
    tbody.appendChild(tr);
  });

  recalc();
  
  // Guardar automáticamente en la base de datos
  saveToDatabase();
}

function validarFormulario(){
  const cliente = $('cliente').value.trim();
  const docCliente = $('docCliente').value.trim();
  const fecha = $('fecha').value.trim();
  const entidad = $('entidad').value.trim();
  const items = document.querySelectorAll('#itemsTable tbody tr');
  
  if(!cliente) {
    showToast('Por favor escribe el nombre del cliente', 'error');
    return false;
  }
  
  if(!docCliente) {
    showToast('Por favor escribe el documento del cliente', 'error');
    return false;
  }
  
  if(!entidad) {
    showToast('Por favor selecciona una entidad', 'error');
    return false;
  }
  
  if(entidad === 'Otra') {
    const entidadOtra = $('entidadOtra').value.trim();
    if(!entidadOtra) {
      showToast('Por favor especifica la entidad personalizada', 'error');
      return false;
    }
  }
  
  if(!fecha) {
    showToast('Por favor selecciona una fecha', 'error');
    return false;
  }
  
  if(items.length === 0) {
    showToast('Por favor agrega al menos un servicio', 'error');
    return false;
  }
  
  let hayItemValido = false;
  items.forEach(r => {
    // Si hay input personalizado, usar su valor; si no, usar el select
    const descEl = r.querySelector('.item-desc-custom') || r.querySelector('.item-desc');
    const desc = descEl.value.trim();
    const price = Number(r.querySelector('.item-price').value || 0);
    if(desc && price > 0) {
      hayItemValido = true;
    }
  });
  
  if(!hayItemValido) {
    showToast('Por favor completa descripción y precio de al menos un servicio', 'error');
    return false;
  }
  
  return true;
}

async function saveToDatabase(){
  if(!validarFormulario()) return;
  
  const payload = collectFormData();
  try {
    const res = await fetch('/api/recibos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ numero: payload.numero, cliente: payload.cliente, fecha: payload.fecha, total: payload.total, data: payload })
    });
    const json = await res.json();
    if(json.ok){
      showToast('✓ Recibo guardado', 'success');
      resetFormulario();
      cargarLista();
    } else {
      showToast('Error guardando: ' + (json.error || 'desconocido'), 'error');
    }
  } catch(e){
    console.error(e);
  }
}

function resetFormulario() {
  // Limpiar campos del cliente
  $('cliente').value = '';
  $('docCliente').value = '';
  $('entidad').value = '';
  $('entidadOtra').value = '';
  document.getElementById('entidadOtraContainer').style.display = 'none';
  
  // Limpiar observaciones
  $('observ').value = '';
  
  // Limpiar tabla de items
  const tbody = document.querySelector('#itemsTable tbody');
  tbody.innerHTML = '';
  addRow();
  
  // Generar nuevo número de recibo
  nextNumber();
  
  // Establecer fecha actual
  setDefaultDate();
  
  // Limpiar preview
  document.querySelector('#r_table tbody').innerHTML = '';
  $('r_cliente').textContent = '';
  $('r_doc').textContent = '';
  $('r_observ').textContent = '';
  $('r_subtotal').textContent = '0.00';
  $('r_iva').textContent = '0.00';
  $('r_total').textContent = '0.00';
}

async function abrirPDF(){
  try {
    const res = await fetch('/api/recibos');
    const arr = await res.json();
    if(!arr || arr.length === 0) {
      showToast('Genera un recibo primero', 'error');
      return;
    }
    // Abrir el recibo con el ID más alto (el más reciente)
    let lastRecibo = arr[0];
    arr.forEach(r => {
      if(r.id > lastRecibo.id) {
        lastRecibo = r;
      }
    });
    lastReciboId = lastRecibo.id;
    
    const pdfWindow = window.open(`/api/recibos/${lastRecibo.id}/pdf`, '_blank');
    pdfWindow.onload = () => {
      setTimeout(() => {
        pdfWindow.print();
      }, 250);
    };
  } catch(e){
    showToast('Error al generar PDF', 'error');
  }
}

async function descargarPDFAnterior(){
  if(!lastReciboId) {
    showToast('No hay PDF anterior', 'error');
    return;
  }
  try {
    const res = await fetch('/api/recibos');
    const arr = await res.json();
    if(!arr || arr.length < 2) {
      showToast('No hay PDF anterior', 'error');
      return;
    }
    // Encontrar el segundo más reciente
    let sorted = arr.sort((a, b) => b.id - a.id);
    const previousRecibo = sorted[1];
    const pdfWindow = window.open(`/api/recibos/${previousRecibo.id}/pdf`, '_blank');
    pdfWindow.onload = () => {
      setTimeout(() => {
        pdfWindow.print();
      }, 250);
    };
  } catch(e){
    showToast('Error al descargar PDF anterior', 'error');
  }
}

async function cargarLista(){
  try {
    const res = await fetch('/api/recibos');
    const recibos = await res.json();
    const cont = document.getElementById('savedItems');
    updateStats(recibos);
    
    if(cont){
      cont.innerHTML = '';
      if(!recibos.length) {
        cont.innerHTML = '<div style="padding:12px;text-align:center;color:#999">No hay recibos guardados</div>';
      } else {
        recibos.forEach(r=>{
          const d = document.createElement('div');
          d.style.borderTop = '1px solid #eee';
          d.style.padding = '12px 0';
          d.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div><strong>Recibo ${escapeHtml(r.numero)}</strong> — ${escapeHtml(r.fecha)}</div>
                <div style="font-size:0.9rem;color:#666;margin-top:2px"><em>${escapeHtml(r.cliente)}</em> — $${escapeHtml(Number(r.total).toFixed(2))}</div>
              </div>
              <div style="display:flex;gap:6px">
                <a href="/api/recibos/${r.id}/pdf" target="_blank" style="padding:6px 10px;background:#10b981;color:white;border:0;border-radius:6px;cursor:pointer;font-size:0.85rem;text-decoration:none;display:inline-block">PDF</a>
                <button class="delete" data-id="${r.id}" style="font-size:0.85rem;padding:6px 10px;background:#ef4444;color:white;border:0;border-radius:6px;cursor:pointer">✕</button>
              </div>
            </div>
          `;
          cont.appendChild(d);
        });
        
        // listeners delete con protección de contraseña
        cont.querySelectorAll('.delete').forEach(b => b.addEventListener('click', async (e)=>{
          const password = prompt('Ingresa la contraseña para eliminar el recibo:');
          if(!password) return;
          if(password !== '1NN4R') {
            showToast('Contraseña incorrecta', 'error');
            return;
          }
          if(!confirm('¿Eliminar este recibo? Esta acción no se puede deshacer.')) return;
          const id = e.target.dataset.id;
          try {
            const res = await fetch(`/api/recibos/${id}`, { method: 'DELETE' });
            const json = await res.json();
            if(json.ok) {
              showToast('Recibo eliminado', 'success');
              cargarLista();
            }
          } catch(e) { 
            console.error(e); 
            showToast('Error eliminando recibo', 'error'); 
          }
        }));
      }
    }
  } catch(e){
    console.error(e);
    showToast('Error cargando lista', 'error');
  }
}

function updateSavedCount(n) {
  if(typeof n === 'undefined') {
    // intentar desde servidor
    fetch('/api/recibos').then(r=>r.json()).then(arr=> {
      updateStats(arr);
    }).catch(()=> {
      updateStats([]);
    });
  }
}

function updateStats(recibos) {
  const hoy = new Date().toISOString().slice(0, 10);
  const recibosHoy = recibos.filter(r => r.fecha === hoy);
  const totalHoy = recibosHoy.reduce((sum, r) => sum + (Number(r.total) || 0), 0);
  
  $('statsRecibosHoy').textContent = recibosHoy.length;
  $('statsTotalHoy').textContent = '$ ' + totalHoy.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

async function resetAllRecibos(){
  if(!confirm('⚠️ ¿Eliminar TODOS los recibos guardados? Esta acción no se puede deshacer.')) return;
  
  const password = prompt('Ingresa la contraseña para eliminar todos los recibos:');
  if(!password) return;
  if(password !== '1NN4R') {
    showToast('Contraseña incorrecta', 'error');
    return;
  }
  
  if(!confirm('Confirma: ¿Eliminar todos los recibos?')) return;
  
  showLoader(true);
  try {
    const res = await fetch('/api/recibos/reset', { method: 'DELETE' });
    const json = await res.json();
    showLoader(false);
    if(json.ok) {
      showToast('✓ Todos los recibos han sido eliminados', 'success');
      cargarLista();
      nextNumber();
    }
  } catch(e) {
    showLoader(false);
    showToast('Error al resetear', 'error');
    console.error(e);
  }
}

function setDefaultReportDates(){
  const hoy = new Date().toISOString().slice(0, 10);
  const mesActual = hoy.slice(0, 7);
  $('reportDiaFecha').value = hoy;
  $('reportMesFecha').value = mesActual;
}

async function generarReporteDiario(){
  const fecha = $('reportDiaFecha').value;
  if(!fecha) {
    showToast('Selecciona una fecha', 'error');
    return;
  }
  try {
    window.open(`/reportes/diario/vista?fecha=${encodeURIComponent(fecha)}`, '_blank');
  } catch(e) {
    showToast('Error generando reporte', 'error');
    console.error(e);
  }
}

async function generarReporteMensual(){
  const mes = $('reportMesFecha').value;
  if(!mes) {
    showToast('Selecciona un mes', 'error');
    return;
  }
  try {
    window.open(`/reportes/mensual/vista?mes=${encodeURIComponent(mes)}`, '_blank');
  } catch(e) {
    showToast('Error generando reporte', 'error');
    console.error(e);
  }
}

// cargar inicial
async function cargar(){
  await cargarLista();
}
cargar();
